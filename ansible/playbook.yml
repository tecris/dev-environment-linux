- hosts: all
  become: true
  become_method: sudo
  vars:
    username: tecris
  roles:
    - { role: ansible-screen }
    - { role: docker.ubuntu,
      docker_opts: "-H tcp://0.0.0.0:4243 -H unix:///var/run/docker.sock --registry-mirror=https://registry.mirror:5000"
    }
    - { role: ansible-java, java_oracle_version: 8u66 }
    - { role: ansible-maven }
    - { role: ansible-role-git }
  tasks:
    # Add user only when testing in docker
    - user: name={{username}}
      tags:
        - only-on-docker
    - name: Avoid using sudo when using docker command
      command: usermod -aG docker {{username}}
    - name: Configure git email
      command: git config --global user.email "eugen@cristea.org"
    - name: Configure git user
      action: shell git config --global user.name "Eugen Cristea"
    - name: Installs tree
      apt: pkg=cryptsetup state=installed update_cache=true
    - name: Installs cryptsetup package
      apt: pkg=tree state=installed update_cache=true
    - name: screen configuration file
      copy: src=files/screenrc dest=/home/{{username}}/.screenrc owner={{username}} mode=0644
    - name: vim configuration file
      copy: src=files/vimrc dest=/home/{{username}}/.vimrc owner={{username}} mode=0644
    - file: path=/home/{{username}}/.m2 owner={{username}} group={{username}} state=directory mode=0775
    - name: maven settings.xml
      copy: src=files/settings.xml dest=/home/{{username}}/.m2/settings.xml owner={{username}} mode=0644
    - file: path=/home/{{username}}/.ssh owner={{username}} group={{username}} state=directory mode=0700
    - name: ssh config
      copy: src=files/ssh_config dest=/home/{{username}}/.ssh/config owner={{username}} mode=0644
    - name: ftp config
      copy: src=files/netrc dest=/home/{{username}}/.netrc owner={{username}} mode=0644
    # cannot edit /etc/hosts with ansible 
    - name: Configure hosts
      lineinfile:
        dest: /etc/hosts
        line: "{{ item.line }}"
      with_items:
        - { line: ''}
        - { line: '127.0.1.1       registry.mirror' }
        - { line: '172.17.0.1      blue.sky' }
      tags:
        - no-docker
